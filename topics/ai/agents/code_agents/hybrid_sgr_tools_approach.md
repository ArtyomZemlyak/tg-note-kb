# Гибридный подход SGR + Tools: Закрываем дыры, не ломая протокол

## Краткое описание

Гибридный подход, объединяющий SGR (Structured Generation Response) с нативными вызовами инструментов, решает проблемы чистого SGR-подхода при работе с вызовами инструментов. Подход использует отдельный инструмент рассуждения (generate_reasoning), который вызывается принудительно сразу после пользовательского сообщения, внутри которого применяется SGR-методология, а затем агент вызывает только явно объявленные функции через нативный механизм.

## Основная информация

### Проблемы чистого SGR-подхода

Чистый SGR-подход генерирует ответы через "поля" и якоря, что приводит к более предсказуемым и точным результатам, но вызывает трудности при интеграции с механизмами вызова инструментов:

- Легко размывает семантику вызова инструментов
- В истории появляются вызовы инструментов, которых не было в объявленном наборе и не передались в чат-шаблон
- Расходится с практиками провайдеров и публичными бенчмарками по агентности
- Возможны проблемы с "hallucination" инструментов

### Решение: Гибридный подход SGR + Tools

Разработчик вынес рассуждение в отдельный инструмент `generate_reasoning` и заставил модель вызывать его принудительно сразу после любого пользовательского сообщения с помощью управления `tool_choice`. Внутри рассуждения используется SGR-методология:

- Цель
- План
- Ограничения
- Проверка предпосылок
- Сигналы о том, нужно ли вызывать инструменты и какие именно

Далее "агент", опираясь на полученное рассуждение, вызывает только те функции, которые явно объявлены в tools, строго через нативный механизм вызовов.

### Ключевые свойства подхода

1. **Никаких "динамических инструментов из воздуха"**: Всё, чем пользуется модель, заранее объявлено; в истории нет инструментов, которых нет в tools. Контроль с помощью tool_choice.

2. **История сообщений валидна и читаема**: Отдельно видно этап рассуждения и отдельно - действия и финальный ответ.

3. **Совместимость с практиками провайдеров и бенчмарками**: Снижается риск hallucination инструментов, корректнее проходит проверка релевантности функций.

4. **Контроль внимания вместо хаоса**: Сначала гарантированное рассуждение, потом действия. Это делает маршрутизацию детерминированной и устойчивой. Благодаря использованию вычислительных ресурсов в обучении появляется возможность как будущей корректной оценки цепочек рассуждения (для метрик), так и адаптивного выбора инструментов.

## Новые концепции и термины

- **Гибридный SGR + Tools**: Подход, объединяющий структурированную генерацию ответов с нативными вызовами инструментов
- **generate_reasoning**: Отдельный инструмент рассуждения, вызываемый принудительно сразу после пользовательского сообщения
- **tool_choice**: Механизм принудительного выбора инструментов для контроля поведения модели
- **Tool hallucination**: Проблема, при которой модель вызывает инструменты, которые не были объявлены или не релевантны

## Примеры применения

- Агенты, требующие четкого разделения между рассуждением и выполнением действий
- Системы, где необходима предсказуемость и прозрачность в вызовах инструментов
- Приложения, где важна совместимость с существующими фреймворками и провайдерами
- Сценарии, где требуется детальный контроль над процессом принятия решений агентом

## Сравнение с другими подходами

### Отличия от "SGR-only" подхода:

- Нативные tool_calls, а не эмуляция вызовов через content
- Меньше неожиданностей для модели: нет сценария "ответил JSON -> внезапно прилетел tool", когда tools пусты
- Проще поддерживать качество: рассуждение становится обычным шагом workflow
- Рассуждение можно вынести на более мощные или более слабые модели по необходимости
- Позволяет давать больше контроля над процессом

### Преимущества устойчивости:

- Более стабильная и интерпретируемая модель поведения
- Чат-шаблон согласован с историей
- Вызовы инструментов не идут "против шерсти"
- Модель ведёт себя предсказуемо

## Архитектура системы

1. **Вход пользователя**: Поступает сообщение от пользователя
2. **Принудительный вызов рассуждения**: Система использует tool_choice для вызова generate_reasoning
3. **SGR-рассуждение**: Внутри инструмента рассуждения применяется SGR-методология
4. **Анализ необходимости инструментов**: Определение, какие инструменты нужно вызвать
5. **Нативные вызовы инструментов**: Вызов только явно объявленных функций
6. **Финальный ответ**: Формирование результата на основе рассуждений и результатов инструментов

## Связи с другими темами

[[ai/agents/code_agents/sgr_code_agent.md]] - Основы SGR подхода в кодовых агентах
[[ai/agents/planact_approach.md]] - Подход к планированию и выполнению задач ИИ-агентами
[[ai/agents/anthropic_skills_approach.md]] - Подход Anthropic к использованию инструментов/скиллов ИИ-агентами
[[ai/llm/applications/llm_market_research.md]] - Применение LLM в различных задачах
[[ai/machine_learning/reasoning_models/hierarchical_reasoning_model_hrm.md]] - Иерархическая модель рассуждения
[[ai/tools/claude_code.md]] - Реализация гибридного подхода к вызову инструментов в коммерческом продукте Anthropic
[[sgr_framework/sgr_core.md]] - Фреймворк sgr-core с реализацией SGR
[[sgr_framework/sgr_core_030_release.md]] - Релиз sgr-core 0.3.0 с улучшениями архитектуры
[[ai/llm/tools/metatool_framework.md]] - Современный подход к обучению LLM освоению инструментов с помощью аугментации мета-задач

## Ссылки на источники

- Оригинальный пост о гибридном подходе SGR + Tools
- Репозиторий с реализацией: упомянут в оригинальном источнике