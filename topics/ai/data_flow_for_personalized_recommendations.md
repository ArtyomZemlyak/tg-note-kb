# Поток данных для персонализированных рекомендаций

## Обзор

Данный документ описывает поток данных в персонализированной LLM архитектуре для Самоката, Мегамаркета и Купера, который позволяет генерировать персонализированные рекомендации в диалоговом режиме.

## Поток данных

### 1. Сбор пользовательских данных (User Data Collection)

#### 1.1. Асинхронный сбор данных
- Пользовательские действия в экосистемах (заказы, просмотры, оценки) отправляются в системы сбора данных
- Используются event logs и API для передачи данных в реальном времени
- Каждое событие включает:
  - ID пользователя (анонимизированный)
  - Тип события (заказ, просмотр, оценка, поиск)
  - Контекст события (время, местоположение, устройство)
  - Метаданные (категория товара, цена, бренд)

#### 1.2. Валидация и очистка данных
- Проверка целостности данных и формата
- Фильтрация дубликатов и аномальных значений
- Приведение данных к унифицированному формату

#### 1.3. Хранение временных данных
- Временные данные хранятся в Apache Kafka
- Данные обрабатываются в батчах или в реальном времени

### 2. Обновление пользовательского профиля (User Profile Update)

#### 2.1. Обработка событий
- Event processor извлекает события из Kafka
- События группируются по пользовательским ID
- Каждое событие классифицируется и обогащается метаданными

#### 2.2. Обновление векторов предпочтений
- Используется инкрементальное обновление векторных представлений предпочтений
- Применяются веса на основе времени и типа взаимодействия
- Рассчитываются приоритеты для различных категорий товаров/услуг

#### 2.3. Обновление профиля в хранилище
- Обновленный профиль сохраняется в PostgreSQL/Redis
- Используется стратегия частичного обновления для повышения эффективности
- Активируется индексация для векторного поиска

### 3. Обработка диалогового запроса (Dialog Request Processing)

#### 3.1. Прием пользовательского запроса
- Диалоговый интерфейс принимает текстовый запрос от пользователя
- Запрос направляется в систему обработки вместе с контекстом сессии

#### 3.2. Извлечение контекста пользователя
- Система извлекает:
  - Идентификатор пользователя
  - Историю диалога в текущей сессии
  - Общую историю взаимодействия с сервисами
  - Актуальные предпочтения и интересы

#### 3.3. Обогащение запроса
- Пользовательский контекст объединяется с текстовым запросом
- Применяется техника prompt engineering для интеграции персонализации
- Формируется расширенный промпт для LLM

### 4. Генерация рекомендаций (Recommendation Generation)

#### 4.1. Вызов LLM
- Расширенный промпт передается в LLM
- Используется подход с retrieval-augmented generation (RAG)
- В промпт интегрируется релевантная персонализированная информация

#### 4.2. Обработка ответа LLM
- Полученный ответ анализируется на наличие рекомендаций
- Выделяются сущности (товары, категории, услуги)
- Оценивается релевантность рекомендаций профилю пользователя

#### 4.3. Пост-обработка
- Применяется фильтрация для исключения не релевантных рекомендаций
- Добавляется контекст из пользовательских данных (доступность, цена, местоположение)
- Генерируется человеко-читаемый ответ с рекомендациями

### 5. Отправка ответа пользователю (Response Delivery)

#### 5.1. Форматирование ответа
- Ответ форматируется в соответствии с требованиями интерфейса
- Добавляются интерактивные элементы при необходимости
- Обеспечивается доступность и удобочитаемость

#### 5.2. Логирование взаимодействия
- Ответ и контекст запроса логируются для будущего анализа
- Записывается оценка пользовательского удовлетворения (если доступна)
- Обновляется история диалога

### 6. Обратная связь и обучение (Feedback and Learning)

#### 6.1. Сбор обратной связи
- Отслеживание пользовательских действий после рекомендаций
- Сбор явной обратной связи (оценки, лайки, жалобы)
- Анализ времени взаимодействия с рекомендациями

#### 6.2. Обновление модели
- Данные обратной связи используются для переобучения модели
- Адаптируются веса в векторах предпочтений
- Обновляются правила генерации рекомендаций

## Временные аспекты

### Реальное время
- Обработка диалогов: <100ms
- Обновление краткосрочных предпочтений: <1s
- Обновление контекста сессии: мгновенно

### Пакетная обработка
- Обновление долгосрочного профиля: каждые 15-30 минут
- Пересчет векторных представлений: каждые 1-2 часа
- Полная переиндексация: ежедневно

## Безопасность и приватность

### Защита данных
- Все персональные данные анонимизируются
- Используется шифрование при передаче и хранении
- Применяются принципы privacity by design

### Соответствие регуляциям
- GDPR/CCPA compliance для пользовательских данных
- Управление согласиями пользователей
- Возможность удаления пользовательских данных