# Flow Matching: Метод обучения генеративных моделей

## Общее описание

**Flow Matching** — это современный подход к обучению генеративных моделей, который позволяет обучать непрерывные нормализующие потоки без необходимости в обратных операциях. В отличие от диффузионных моделей, которые постепенно добавляют шум к данным, flow matching обучает непрерывный поток, который преобразует простое распределение в целевое распределение данных.

## Математическая основа

### Принцип непрерывных нормализующих потоков
- Использует непрерывное преобразование между распределениями
- Обучает векторное поле, которое описывает, как точки данных преобразуются из одного распределения в другое
- Позволяет точный расчет логарифмической вероятности

### Векторное поле скорости
- Flow matching обучает поле скорости v(x, t), которое определяет, как точки перемещаются во времени
- В отличие от диффузии, которое работает с конечными шагами, flow matching оперирует с непрерывным временем
- Это позволяет более эффективное обучение и генерацию

## Отличия от диффузионных моделей

### Flow Matching vs. Diffusion
- **Векторное предсказание**:
  - Диффузионные модели часто предсказывают шум (e-prediction) или скорость/обновление (v-prediction)
  - Flow matching может быть параметризован для предсказания чистого конечного состояния (x-prediction), как в [[dreamer4.md|Dreamer 4]]

- **Обучение**:
  - Flow matching обучает непрерывный поток напрямую
  - Диффузия использует дискретные шаги в прямом процессе

- **Эффективность**:
  - Flow matching может быть более эффективным в генерации
  - Позволяет точную вероятностную оценку

## Единая теория диффузионных моделей

Согласно единой теории диффузионных моделей, потоковый подход (Flow Matching) математически эквивалентен другим подходам - вариационному (например, DDPM) и основанный на score-функции (например, Score SDE). Все три подхода сводятся к одному ключевому принципу: обучению зависящего от времени векторного поля для обращения фиксированного прямого процесса зашумления. 

Центральное уравнение, описывающее все три подхода - это дифференциальное уравнение Probability Flow ODE (PF-ODE):
dx(t)/dt = f(x(t), t) - ½ g²(t) ∇ₓ log pₜ(x(t))

### Связь с Probability Flow ODE
- Flow Matching обучает векторное поле скоростей, управляющее непрерывным потоком
- Это поле определяется таким образом, чтобы эволюция плотности вероятности pₜ(x) подчинялась уравнению Фоккера-Планка
- PF-ODE конструируется так, чтобы поток его семплов подчинялся тому же закону, что гарантирует одинаковые маргинальные распределения для обоих процессов

## Применения

### Видео генерация
- [[dreamer4.md|Dreamer 4]] использует модифицированную версию flow matching с x-prediction для стабильного предсказания на длинных горизонтах в видео
- Используется в [[ai/llm/models/kandinsky_video_5.md|Kandinsky Video 5]] для генерации видео

### Медицинские приложения
- [[CellFlux]] использует flow matching для симуляции клеточных морфологических изменений

### World модели
- Применяется в современных world моделях для стабильной симуляции динамики
- Позволяет предсказывать эволюцию состояний в сложных средах

## Ключевые инновации

### X-Prediction в контексте Flow Matching
- Вместо предсказания вектора обновления (v-prediction), модель предсказывает чистое конечное состояние
- Это критически важно для стабильности на длинных горизонтах
- Позволяет избежать накопления малых ошибок на каждом шаге
- Реализовано в [[dreamer4.md|Dreamer 4]] с новой целевой функцией "shortcut forcing"

### Shortcut Forcing
- Метод, использующий идеи flow matching для обучения модели генерировать кадр за один большой шаг
- "Бутстрэпится" из двух шагов вдвое меньшего размера
- Позволяет эффективное обучение прямому "короткому пути" (shortcut) к конечному результату

## Преимущества

- **Стабильность** на длинных временных горизонтах
- **Эффективность** генерации
- **Точность** в предсказании сложных динамик
- **Масштабируемость** для больших моделей

## Ограничения и вызовы

- **Сложность реализации** в сравнении с дискретными методами
- **Требования к вычислительным ресурсам** для обучения
- **Чувствительность** к параметризации векторного поля

## Будущее развитие

- Интеграция с трансформерными архитектурами
- Применение в реальном времени симуляции
- Совместимость с архитектурами, использующими долгосрочную память

## Связи с другими темами

- [[dreamer4.md|Dreamer 4]] - применение flow matching в масштабируемых world моделях
- [[diffusion_models.md|Диффузионные модели]] - альтернативный подход к генерации
- [[computer_vision/world_models.md|World модели]] - применение в моделях мира
- [[generative_models.md|Генеративные модели]] - общая категория
- [[theory/unified_theory_of_diffusion_models.md|Единая теория диффузионных моделей]] - теоретическая основа, объединяющая все подходы