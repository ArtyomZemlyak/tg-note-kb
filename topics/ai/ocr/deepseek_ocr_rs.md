# DeepSeek-OCR.rs

## Описание

DeepSeek-OCR.rs - это реализация DeepSeek-OCR на языке Rust с быстрой командной строкой и совместимым с OpenAI HTTP-сервером. Представляет собой стек инференса для модели понимания документов с возможностями OCR, написанный полностью на Rust без необходимости в Python-окружении.

## Особенности реализации

### Пайплайн обработки визуальных данных
- **Визуальная предобработка**: `prepare_vision_input_from_image` строит квадратный глобальный холст с буквоедлением и динамической предобработкой с тайлингом для локальных кропов высокого разрешения
- **Слияние SAM + CLIP**: Использует порты Candle для SAM (SamBackbone) и CLIP-L (ClipVisionModel) с пространственным выравниванием
- **Проектор и лейаут токены**: Пользовательский ImageProjector отображает объединенные каналы SAM/CLIP в размер скрытого слоя языка
- **Токенизация**: Создает токены промпта с промежутками <image>, соответствующими количеству спроецированных токенов
- **Декодер**: Переписанная на Candle версия DeepSeek-V2 с FlashAttention, вращающимися встраиваниями и DynamicCache

### Поддержка двойного интерфейса
- **CLI**: Интерфейс командной строки для пакетной обработки
- **HTTP-сервер, совместимый с OpenAI**: Сервер на основе Rocket с эндпоинтами `/v1/chat/completions`
- **Общий код**: Чистая реализация визуального/пользовательского пайплайна на Rust, используемая обоими интерфейсами

## Технический стек

- **Candle**: Для тензорных вычислений с поддержкой бэкендов Metal и CUDA
- **Rocket**: HTTP-сервер с асинхронным стримингом
- **tokenizers**: Выпуск DeepSeek с зеркалами Hugging Face и ModelScope
- **Rust**: Основной язык реализации (89,7% кодовой базы)

## Поддержка аппаратного ускорения

- **Apple Metal**: Оптимизирован для Apple Silicon с выполнением в FP16
- **CUDA**: Альфа-поддержка для графических процессоров NVIDIA (требуется CUDA 12.2+)
- **Intel MKL**: Поддержка.preview для ускорения на x86
- **CPU**: Стандартная поддержка CPU-инференса

## Ключевые преимущества по сравнению с Python-версией

- Более мелкие развертываемые артефакты (без Python-среды выполнения)
- Безопасная работа с памятью, инфраструктура, дружелюбная к потокам
- Более быстрый холодный старт на Apple Silicon
- Детерминированные загрузки активов из Hugging Face или ModelScope
- Нативное бинарное распространение
- Совместимость с клиентами OpenAI без адаптеров

## Установка и использование

### Системные требования
- Rust 1.78+ с поддержкой edition 2024
- Git
- Опционально: Apple Silicon/macOS 13+ для ускорения Metal
- Опционально: CUDA 12.2+ для ускорения на GPU NVIDIA
- Hugging Face аккаунт с HF_TOKEN рекомендуется

### Команды быстрого старта
```bash
# Клонирование и загрузка
git clone https://github.com/TimmyOVO/deepseek-ocr.rs.git
cd deepseek-ocr.rs
cargo fetch

# CLI использование
cargo run -p deepseek-ocr-cli --release -- \
  --prompt "<image>\n<|grounding|>Convert this receipt to markdown." \
  --image baselines/sample/images/test.png \
  --device cpu --max-new-tokens 512

# Серверное использование
cargo run -p deepseek-ocr-server --release -- \
  --host 0.0.0.0 --port 8000 \
  --device cpu --max-new-tokens 512
```

## Конфигурация

- **Файл конфигурации**: `config.toml` создается автоматически
- **Расположения кэша моделей**:
  - Linux: `~/.cache/deepseek-ocr/models/<id>/`
  - macOS: `~/Library/Caches/deepseek-ocr/models/<id>/`
  - Windows: `%LOCALAPPDATA%\deepseek-ocr\models\<id>\`

## Производительность

- **Сравнение производительности**: Реализация на Rust показывает значительное улучшение производительности по сравнению с эталонной Python-версией
  - Цикл декодирования токенов: в 1,46 раза быстрее
  - Сборка промптов: в 97,42 раза быстрее
  - Общий декод: в 1,88 раза быстрее
- **Размер модели**: ~6,3 ГБ модель с ~13 ГБ требованием RAM во время инференса

## Структура репозитория

- `crates/core`: Общий пайплайн инференса и загрузчики моделей
- `crates/cli`: Интерфейс командной строки
- `crates/server`: HTTP-сервер с совместимостью OpenAI
- `crates/assets`: Управление и помощники по загрузке активов
- `baselines/`: Эталонные входы и выходы для тестирования

## Планы на будущее

- Полное выравнивание нормализации проектора
- Порты функций разметки и стриминга
- Улучшения кроссплатформенного ускорения
- Структурированные выходы JSON-схемы для автоматизации
- Бинарные выпуски с детерминированными контрольными суммами

## Отличия от оригинальной DeepSeek OCR

DeepSeek-OCR.rs - это не новая версия модели DeepSeek OCR, а Rust-реализация существующей архитектуры. Основные отличия:
- Написан на Rust, а не на Python
- Не требует Python-окружения для запуска
- Более быстрый и эффективный
- Лучше поддерживает локальные запуски
- Имеет встроенный HTTP-сервер с API, совместимым с OpenAI

Реализация предоставляет автономное решение для OCR с высокой производительностью, которое может работать локально на CPU, Apple Metal или NVIDIA CUDA GPU без необходимости в зависимостях Python.

## Связи с другими темами

- [[deepseek_ocr.md]] - Оригинальная модель DeepSeek OCR, которую реализует Rust-версия