# Shampoo - Оптимизатор с предобуславливанием на основе ковариации градиентов

## Описание

Shampoo - это алгоритм второго порядка оптимизации, который использует предобуславливание на основе ковариации градиентов. Shampoo был одним из первых алгоритмов отбеливания матриц, предлагающих более сложное предобуславливание, чем диагональные приближения, используемые в традиционных адаптивных оптимизаторах.

## Механизм работы

Shampoo вычисляет предобуславливающие матрицы на основе ковариации градиентов по каждому режиму тензора весов отдельно:

Для тензора весов W вычисляются отдельные предобуславливающие матрицы для каждого режима:
```
A = (GGᵀ + λI)^{-1/2}
B = (GᵀG + λI)^{-1/2}
```

Где G представляет градиенты, соответствующим образом преобразованные для каждого режима тензора. Обновление становится:
```
W ← A W B
```

Этот подход эффективно "отбеливает" пространство градиентов, применяя обратный квадратный корень из матриц моментов второго порядка.

## Особенности

1. **Отбеливание градиентов**: Shampoo стремится сделать ландшафт оптимизации более изотропным, отбеливая градиентные векторы

2. **Раздельная обработка режимов**: В отличие от полной матрицы ковариации, Shampoo обрабатывает каждый режим тензора отдельно, что делает его вычислительно осуществимым

3. **Ковариационные приближения**: Использует факторы Кронекера для приближенного вычисления полной матрицы отбеливания

4. **База для других оптимизаторов**: Shampoo стал основой для более сложных оптимизаторов, таких как SOAP

## Преимущества

- **Лучшая обработка плохо обусловленных задач**: Shampoo более эффективен, когда ландшафт потерь имеет различную кривизну в разных направлениях
- **Улучшенная сходимость**: За счет учета геометрии ландшафта потерь, Shampoo может достигать минимумов более прямым путем
- **Расширяемость**: Основа для более продвинутых методов, таких как SOAP

## Вычислительные затраты

- **Память**: Shampoo требует значительно больше памяти по сравнению с Adam из-за хранения ковариационных матриц
- **Вычисления**: Более вычислительно затратен из-за матричных операций, особенно вычисления обратных квадратных корней

## Эволюция Shampoo в другие оптимизаторы

Shampoo стал основой для других матричных отбеливающих оптимизаторов:
- SOAP улучшает и стабилизирует Shampoo
- Другие производные оптимизаторы применяют различные приближения для повышения эффективности

## Интеграции и упоминания

- [[matrix_whitening_optimizers.md]] - Контекст семейства матричных отбеливающих оптимизаторов
- [[soap_optimizer.md]] - Улучшенная версия Shampoo
- [[muon_optimizer.md]] - Альтернативный подход к матричному отбеливанию
- [[optimizer_quantization_relationship.md]] - Исследование показывает, что Shampoo дает модели, наиболее податливые к квантованию, несмотря на высокие значения MMR и kurtosis

## Ссылки на источники

- Gupta, S., et al. (2018). Shampoo: Preconditioned Stochastic Tensor Optimization. http://proceedings.mlr.press/v80/gupta18a.html
- Zhang, S., et al. (2024). SOAP: Improving and Stabilizing Shampoo. https://arxiv.org/abs/2409.11321
- Frans, K., Abbeel, P., & Levine, S. (2024). What Really Matters in Matrix-Whitening Optimizers? https://arxiv.org/abs/2510.25000