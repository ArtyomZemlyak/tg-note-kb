# Count-Min Sketch: эффективная структура данных для оценки частот

## Описание

Count-Min Sketch (CMS) - это вероятностная структура данных, предназначенная для эффективного подсчета частот элементов в потоке данных. Она особенно полезна, когда необходимо обрабатывать миллиарды уникальных ID, где традиционные методы хранения частот становятся непрактичными из-за ограничений по памяти.

## Контекст и проблема

При работе с рекомендательными системами, особенно в таких компаниях как Pinterest, возникает необходимость коррекции logQ (logarithmic quantization) и семплирования негативов по популярности. Традиционный подход требует создания таблицы частот для каждого item_id, что при миллионах и миллиардах уникальных ID может потреблять огромные объемы памяти.

Например, таблица частот для 1 миллиона ID может занимать около 4 ГБ, и каждый порядок увеличения количества ID будет приводить к кратному увеличению потребления памяти. Это создает серьезные ограничения для систем, обрабатывающих большие объемы данных.

## Архитектура и реализация

CMS реализует маленькую таблицу фиксированного размера, которая не растет даже при поступлении миллиардов новых ID. Структура представляет собой двумерный массив размером `d × w`, где:

- `d` - количество независимых хеш-функций
- `w` - ширина таблицы (размерность по столбцам)

Каждый элемент обрабатывается несколькими независимыми хеш-функциями, и соответствующие счетчики в таблице увеличиваются. При запросе частоты элемента возвращается минимальное значение из всех ячеек, соответствующих этому элементу.

**Визуальное представление структуры Count-Min Sketch:**

```
       cols →
     0   1   2   3   4   5   ...
h₁ [ 0 | 5 | 0 | 2 | 0 | 1 | ... ]
h₂ [ 3 | 0 | 4 | 0 | 2 | 0 | ... ]
h₃ [ 0 | 1 | 0 | 3 | 0 | 2 | ... ]
```

Один и тот же ID каждый раз попадает в одни и те же клетки, аккуратно увеличивая их значения.

**Примечание по медиа:** В случае появления визуализации структуры Count-Min Sketch в медиа-каталоге, сюда можно будет добавить соответствующее изображение с описанием.

## Алгоритм работы

1. **Инициализация**: Создание таблицы размером `d × w` с нулевыми значениями
2. **Обновление**: При поступлении элемента `x`, для каждой хеш-функции `h_i` увеличивается значение в ячейке `(i, h_i(x))`
3. **Запрос частоты**: При запросе частоты элемента `x`, возвращается `min(C[1, h_1(x)], C[2, h_2(x)], ..., C[d, h_d(x)])`

## Преимущества

- **Фиксированный размер памяти**: Размер структуры не зависит от количества уникальных элементов
- **Эффективность**: Операции обновления и запроса выполняются за O(d), где d обычно мало
- **Гарантированная верхняя граница ошибки**: Алгоритм предоставляет гарантии точности в виде вероятностных границ
- **Полезная регуляризация**: Погрешность слегка занижает популярность самых популярных элементов, что может давать бесплатную регуляризацию в logQ и семплировании негативов

## Применение в рекомендательных системах

CMS находит широкое применение в рекомендательных системах:

- **Оценка частот**: Для семплирования негативов пропорционально популярности
- **Коррекция logQ**: Для учета несбалансированности в частотах показов элементов
- **Мониторинг популярности**: Для отслеживания изменений в популярности контента в реальном времени
- **Оценка метрик**: Для подсчета показателей без хранения всех данных в памяти

## Теоретические гарантии

Точность CMS можно контролировать через параметры структуры:
- Ширина `w` связана с вероятностью ошибки: `w = ⌈e / ε⌉` где `ε` - допустимая ошибка
- Глубина `d` связана с уверенностью: `d = ⌈ln(1/δ)⌉` где `δ` - вероятность превышения ошибки

Это позволяет настраивать баланс между памятью, точностью и скоростью выполнения.

## Сравнение с альтернативными подходами

| Метод | Память | Точность | Скорость | Применимость |
|-------|--------|----------|----------|--------------|
| Точное хранение | O(n) | Идеальная | O(1) | Маленькие наборы |
| Count-Min Sketch | O(1) | Приближенная | O(d) | Большие потоки данных |
| Count Sketch | O(1) | Приближенная | O(d) | С отрицательными частотами |

## Ограничения

- **Приближенные результаты**: Всегда присутствует небольшая ошибка в оценке частот
- **Невозможность удаления**: Стандартная реализация не поддерживает декремент частот
- **Потенциальные коллизии**: При большом количестве элементов возможны хеш-коллизии

## Связь с унифицированными эмбеддингами

CMS демонстрирует схожий подход к решению проблемы масштаба, как и унифицированные эмбеддинги (unified embeddings). Оба метода используют вероятностные структуры для эффективного хранения информации при больших объемах данных. В то время как унифицированные эмбеддинги решают проблему масштаба в таблицах эмбеддингов, CMS решает проблему масштаба в хранении частот.

## Связи с другими темами

- [[unified_embeddings.md]] - Альтернативный подход к решению проблемы масштаба в рекомендательных системах
- [[../../computer_science/cs_fundamentals/algorithms_data_structures.md]] - Фундаментальные структуры данных для ИИ и машинного обучения
- [[denserec.md]] - Решение проблемы холодного старта в рекомендательных системах
- [[../llm_based/linkedin_large_scale_retrieval.md]] - Применение подходов для работы с большими масштабами данных

## Источники

1. [An Improved Data Stream Summary: The Count-Min Sketch and its Applications](https://www.cs.princeton.edu/courses/archive/spring17/cos598C/bib/Cormode2005.pdf) - Оригинальная научная работа Грэхэма Кормода и С. Мутхукришнана, описывающая Count-Min Sketch и его применения, опубликованная в 2005 году
2. [Count-min sketch - Encyclopedia of Database Systems](https://link.springer.com/referenceworkentry/10.1007%2F978-0-387-39940-9_424) - Подробная статья о Count-Min Sketch в энциклопедии систем баз данных, Springer, 2009 год
3. [Wikipedia - Count–min sketch](https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch) - Обзорная статья в Wikipedia с описанием математических основ, реализации и применений алгоритма
4. [Understanding Count-Min Sketch: A Space-Efficient Probabilistic Data Structure](https://arvinth-16.medium.com/understanding-count-min-sketch-a-space-efficient-probabilistic-data-structure-0da38e7e44e4) - Объяснение вероятностной структуры данных Count-Min Sketch и ее применений в задачах обработки больших данных