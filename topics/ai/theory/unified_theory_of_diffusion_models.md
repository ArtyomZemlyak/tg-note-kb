# Единая теория диффузионных моделей: От VAE до Flow Matching

## Общее описание

Единая теория диффузионных моделей представляет собой фундаментальный теоретический каркас, который объединяет три исторически разных подхода к генеративному моделированию: вариационный (например, DDPM), основанный на score-функции (например, Score SDE) и потоковый (например, Flow Matching). Все они математически эквивалентны и сводятся к одному ключевому принципу: обучению зависящего от времени векторного поля для обращения фиксированного прямого процесса зашумления.

## Три основных подхода

### 1. Вариационный подход (VAE)
- Происходит от вариационных автоэнкодеров (VAE)
- Приводит к Denoising Diffusion Probabilistic Models (DDPM)
- Генерация рассматривается как иерархический процесс удаления шума
- Модель учится обращать фиксированный, многошаговый процесс зашумления
- Оптимизация происходит через максимизацию вариационной нижней оценки (ELBO) правдоподобия данных

### 2. Подход на основе score-функции
- Основан на энергетических моделях (EBM)
- Фокусируется на выучивании score-функции (∇ₓlog p(x)) - градиента логарифма плотности данных
- Это векторное поле указывает на области с более высокой вероятностью
- Следуя ему, можно превратить шум в данные
- Приводит к моделям Noise Conditional Score Networks (NCSN) и фреймворку Score SDE

### 3. Потоковый подход (Flow Matching)
- Вдохновлён нормализующими потоками (Normalizing Flows) и нейронными ОДУ
- Моделирует генерацию как детерминированный процесс переноса
- Выученное поле скоростей управляет непрерывным потоком
- Преобразует простое априорное распределение в сложное распределение данных

## Ключевая математическая структура: Probability Flow ODE (PF-ODE)

Все три подхода описываются одним детерминированным дифференциальным уравнением:

dx(t)/dt = f(x(t), t) - ½ g²(t) ∇ₓ log pₜ(x(t))

Где:
- x(t) - состояние в момент времени t
- f(x(t), t) - векторное поле
- g(t) - функция шума
- ∇ₓ log pₜ(x(t)) - score-функция плотности в момент t

Практически, истинная score-функция ∇ₓ log pₜ(x(t)) неизвестна и заменяется обученной нейросетью s_φˣ(x(t), t), что даёт эмпирическое ОДУ для семплинга.

Согласованность между этим детерминированным ОДУ и его стохастическими аналогами (SDE) гарантируется уравнением Фоккера-Планка.

## "Трюк с обусловливанием" для эффективного обучения

Ключевая идея, позволяющая обучать диффузионные модели эффективно - трюк с обусловливанием. Основные функции потерь для обучения вычислительно сложны из-за необходимости score-функции маргинальной плотности pₜ(xₜ), включающей интеграл по неизвестному распределению данных.

Трюк с обусловливанием элегантно обходит эту проблему:
- Целью регрессии становится score-функция условной плотности pₜ(xₜ|x₀)
- Эта функция является известным гауссианом с простой аналитической формой

Все функции потерь для диффузионных моделей сводятся к единому шаблону:
L(φ) := Eₓ₀,ε,t [ ω(t) || NN_φ(xₜ, t) - (Aₜx₀ + Bₜε) ||₂² ]

где xₜ = αₜx₀ + σₜε, и выбор цели (шум ε, данные x₀, score s, скорость v) меняет коэффициенты Aₜ и Bₜ.

## Алгебраическая эквивалентность параметризаций

Различные цели при обучении - шум (e-prediction), чистые данные (x-prediction), score-функция (s-prediction) или скорость (v-prediction) - алгебраически взаимозаменяемы. Их различия - вопрос реализации и стабильности, а не фундаментальных возможностей моделирования.

## Практические приложения теории

### Управляемая генерация (guidance)
Техники управления генерацией элегантно объясняются через байесовское разложение условной score-функции. Например, Classifier-Free Guidance (CFG) моделирует условную score-функцию как линейную комбинацию безусловной и условной:
∇ₓₜ log pₜ(xₜ|c, ω) ≈ ω s_φˣ(xₜ, t, c) + (1 - ω) s_φˣ(xₜ, t, ∅)

### Ускорение семплинга
На основе единой теории рассматриваются два основных подхода:

1. **Ускорение без обучения** (улучшение солвера):
   - Рассматривает обученную диффузионную модель как фиксированное векторное поле
   - Фокусируется на разработке лучших численных решателей ОДУ
   - Примеры: DDIM, DEIS, DPM-Solver

2. **Ускорение на основе обучения** (выучивание карты решений):
   - Выучивает карту решений ОДУ, Ψₛ→ₜ, напрямую
   - Примеры: Consistency Models, которые обучают быстрый, малошаговый генератор
   - Основаны на соблюдении свойства полугруппы для потоков ОДУ

## Связи с другими темами

- [[../../flow_matching.md|Flow Matching]] - потоковый подход к диффузионным моделям
- [[../../llm/diffusion_models.md|Диффузионные модели]] - общее описание диффузионных моделей
- [[../../llm/models/generative_models.md|Генеративные модели]] - общая категория генеративных моделей
- [[../../nlp/transformers/free_transformer.md|Свободный Трансформер]] - VAE-подход в трансформерах
- [[../../optimization/evolutionary_algorithms.md]] - дифференциальная эволюция - другой подход к "диффузионным" алгоритмам
- [[../../computer_vision/diffusion_pixel_space.md|Диффузионные модели в пиксельном пространстве]] - сравнение различных подходов к предсказанию (x0, ε, v) в контексте обучения на подпространствах